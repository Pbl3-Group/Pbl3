@model HeThongTimViec.ViewModels.QuanLyUngVien.ChiTietHoSoUngVienViewModel
@using HeThongTimViec.Models
@using HeThongTimViec.Extensions
@using HeThongTimViec.Helpers 
@{
    ViewData["Title"] = $"Hồ sơ ứng viên: {Model.HoTen}";
    Layout = "_LayoutCompany";
}

@Html.AntiForgeryToken() @* For AJAX POST requests *@

<div class="container my-4">
    <div class="row">
        <div class="col-lg-4">
            <!-- Candidate Info Card -->
            <div class="card shadow-sm mb-4">
                <div class="card-body text-center">
                    <img src="@Model.AvatarUrl" class="img-fluid rounded-circle shadow-sm mx-auto mb-3" alt="Avatar ứng viên" style="width: 120px; height: 120px; object-fit: cover;">
                    <h4 class="card-title mb-1">@Model.HoTen</h4>
                    <p class="text-muted small">@Model.TieuDeHoSo</p>
                    <hr />
                    <ul class="list-unstyled text-start small">
                        <li class="mb-2"><i class="fas fa-envelope fa-fw me-2 text-primary"></i> @Model.Email</li>
                        <li class="mb-2"><i class="fas fa-phone fa-fw me-2 text-primary"></i> @Model.SoDienThoai</li>
                        <li class="mb-2"><i class="fas fa-map-marker-alt fa-fw me-2 text-primary"></i> @Model.DiaChiDayDu</li>
                        @if (Model.NgaySinh.HasValue)
                        {
                            <li class="mb-2"><i class="fas fa-birthday-cake fa-fw me-2 text-primary"></i> @Model.NgaySinh.Value.ToString("dd/MM/yyyy") (@(DateTime.Now.Year - Model.NgaySinh.Value.Year) tuổi)</li>
                        }
                        @if (!string.IsNullOrEmpty(Model.GioiTinh))
                        {
                            <li class="mb-2"><i class="fas fa-venus-mars fa-fw me-2 text-primary"></i> @Model.GioiTinh</li>
                        }
                    </ul>
                </div>
            </div>

            <!-- Application Context Card -->
            @if (Model.UngTuyenIdContext.HasValue)
            {
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-light">
                        <h5 class="mb-0">Thông tin ứng tuyển</h5>
                    </div>
                    <div class="card-body small">
                        <p><strong>Vị trí ứng tuyển:</strong> @Model.TenTinTuyenDungUngTuyen</p>
                        <p><strong>Ngày nộp hồ sơ:</strong> @Model.NgayNopUngTuyen?.ToString("dd/MM/yyyy HH:mm")</p>
                        <p class="mb-2">
                            <strong>Trạng thái hiện tại:</strong>
                            <span id="ungTuyenStatusBadge" class="badge @(Model.TrangThaiUngTuyenHienTai.HasValue ? ViewHelper.GetUngVienTrangThaiBadgeClass(Model.TrangThaiUngTuyenHienTai.Value) : "bg-secondary")">
                                @Model.TrangThaiUngTuyenHienTai?.GetDisplayName()
                            </span>
                        </p>

                        @if (!string.IsNullOrEmpty(Model.UrlCvDaNopChoTinNay))
                        {
                            <a href="@Model.UrlCvDaNopChoTinNay" target="_blank" class="btn btn-primary btn-sm mb-3 w-100"><i class="fas fa-file-pdf me-1"></i> Xem CV đã nộp cho tin này</a>
                        }
                        @if (!string.IsNullOrEmpty(Model.ThuGioiThieuChoTinNay))
                        {
                            <h6>Thư giới thiệu:</h6>
                            <p class="text-muted" style="white-space: pre-wrap; max-height: 150px; overflow-y: auto;">@Model.ThuGioiThieuChoTinNay</p>
                        }

                        @if (Model.TrangThaiUngTuyenHienTai.HasValue && Model.TrangThaiUngTuyenHienTai != TrangThaiUngTuyen.darut)
                        {
                            <hr />
                            <h6>Cập nhật trạng thái:</h6>
                            <div class="btn-group d-flex mb-2" role="group">
                                <button class="btn btn-sm btn-outline-success change-status-btn-detail flex-fill" data-ungtuyenid="@Model.UngTuyenIdContext.Value" data-newstatus="@((int)TrangThaiUngTuyen.daduyet)">
                                    <i class="fas fa-check-circle me-1"></i>Phù hợp
                                </button>
                                @if(Model.TrangThaiUngTuyenHienTai != TrangThaiUngTuyen.ntddaxem && Model.TrangThaiUngTuyenHienTai != TrangThaiUngTuyen.daduyet && Model.TrangThaiUngTuyenHienTai != TrangThaiUngTuyen.bituchoi)
                                {
                                     <button class="btn btn-sm btn-outline-info change-status-btn-detail flex-fill" data-ungtuyenid="@Model.UngTuyenIdContext.Value" data-newstatus="@((int)TrangThaiUngTuyen.ntddaxem)">
                                        <i class="fas fa-eye me-1"></i>Đã xem
                                    </button>
                                }
                                <button class="btn btn-sm btn-outline-danger change-status-btn-detail flex-fill" data-ungtuyenid="@Model.UngTuyenIdContext.Value" data-newstatus="@((int)TrangThaiUngTuyen.bituchoi)">
                                    <i class="fas fa-times-circle me-1"></i>Từ chối
                                </button>
                            </div>
                        }
                        else if (Model.TrangThaiUngTuyenHienTai == TrangThaiUngTuyen.darut)
                        {
                            <hr/>
                            <p class="text-warning small"><i class="fas fa-ban me-2"></i>Ứng viên đã rút hồ sơ, không thể thay đổi trạng thái.</p>
                        }
                         <div id="status-update-message-detail" class="mt-2"></div>
                    </div>
                </div>
            }
        </div>

        <div class="col-lg-8">
            <!-- Candidate Profile Details Card -->
            <div class="card shadow-sm">
                <div class="card-header bg-light">
                    <h5 class="mb-0">Chi tiết Hồ sơ Ứng viên</h5>
                </div>
                <div class="card-body">
                    <section class="mb-4">
                        <h5><i class="fas fa-user-tie fa-fw me-2 text-primary"></i>Giới thiệu bản thân</h5>
                        <p style="white-space: pre-wrap;">@(Model.GioiThieuBanThan ?? "Chưa cập nhật thông tin.")</p>
                    </section>
                    <hr />

                    <section class="mb-4">
                        <h5><i class="fas fa-bullseye fa-fw me-2 text-primary"></i>Vị trí & Lương mong muốn</h5>
                        <p><strong>Vị trí mong muốn:</strong> @(Model.ViTriMongMuon ?? "Chưa cập nhật")</p>
                        <p><strong>Loại lương:</strong> @(Model.LoaiLuongMongMuonDisplay ?? "Chưa cập nhật")</p>
                        <p><strong>Mức lương:</strong> @(Model.MucLuongMongMuonDisplay ?? "Chưa cập nhật")</p>
                        @if (!string.IsNullOrEmpty(Model.UrlCvMacDinh))
                        {
                            <p><a href="@Model.UrlCvMacDinh" target="_blank" class="btn btn-info btn-sm"><i class="fas fa-file-pdf me-1"></i> Xem CV mặc định (hồ sơ)</a></p>
                        }
                    </section>
                    <hr />

                    <section class="mb-4">
                        <h5><i class="fas fa-map-marked-alt fa-fw me-2 text-primary"></i>Khu vực mong muốn làm việc</h5>
                        @if (Model.DiaDiemMongMuonsDisplay.Any())
                        {
                            <ul class="list-inline">
                                @foreach (var diaDiem in Model.DiaDiemMongMuonsDisplay)
                                {
                                    <li class="list-inline-item"><span class="badge bg-light text-dark border me-1">@diaDiem</span></li>
                                }
                            </ul>
                        }
                        else { <p class="text-muted">Chưa cập nhật.</p> }
                    </section>
                    <hr />

                    <section class="mb-4">
                        <h5><i class="far fa-calendar-alt fa-fw me-2 text-primary"></i>Lịch rảnh có thể làm việc</h5>
                        @if (Model.LichRanhs.Any())
                        {
                             <ul class="list-unstyled">
                                @foreach (var lich in Model.LichRanhs)
                                {
                                    <li><i class="far fa-clock me-2 text-muted"></i>@lich.NgayTrongTuan - @lich.BuoiLamViec</li>
                                }
                            </ul>
                        }
                        else { <p class="text-muted">Chưa cập nhật.</p> }
                    </section>
                    <hr />
                    
                    @* TODO: Add sections for KinhNghiemLamViec, HocVan etc. if you have those ViewModels and data *@

                    <div class="mt-4 pt-3 border-top">
                        <a asp-controller="TinNhan" asp-action="Index" asp-route-nguoiLienHeId="@Model.UngVienId" asp-route-ungTuyenId="@Model.UngTuyenIdContext" class="btn btn-success me-2">
                            <i class="fas fa-comments me-2"></i>Liên hệ / Gửi tin nhắn
                        </a>
                        <a asp-action="Index" asp-controller="QuanLyUngVien" class="btn btn-outline-secondary">
                            <i class="fas fa-arrow-left me-2"></i>Quay lại danh sách
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
    $(document).ready(function () {
        $('.change-status-btn-detail').click(function (e) {
            e.preventDefault();
            var button = $(this);
            var ungTuyenId = button.data('ungtuyenid');
            var newStatusValue = button.data('newstatus'); // This is an integer value of the enum

            if (!confirm('Bạn có chắc chắn muốn thay đổi trạng thái của ứng tuyển này?')) {
                return;
            }

            var token = $('input[name="__RequestVerificationToken"]').val();

            $.ajax({
                url: '@Url.Action("ThayDoiTrangThai", "QuanLyUngVien")',
                type: 'POST',
                data: {
                    ungTuyenId: ungTuyenId,
                    newStatus: newStatusValue, // Send as integer
                    __RequestVerificationToken: token
                },
                success: function (response) {
                    var messageDiv = $('#status-update-message-detail');
                    if (response.success) {
                        var statusBadge = $('#ungTuyenStatusBadge');
                        if (statusBadge.length) {
                             statusBadge.removeClass().addClass('badge ' + response.newBadgeClass).text(response.newStatusDisplay);
                        }
                        messageDiv.html('<div class="alert alert-success alert-dismissible fade show" role="alert">' + response.message + '<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button></div>');
                        
                        // Update button states based on new status
                        // Model.TrangThaiUngTuyenHienTai would need to be a JS var updated here
                        // For simplicity, we can disable buttons or hide them
                        if (newStatusValue == @((int)TrangThaiUngTuyen.daduyet) || newStatusValue == @((int)TrangThaiUngTuyen.bituchoi)) {
                            $('.change-status-btn-detail').prop('disabled', true).addClass('disabled');
                        }
                        if (newStatusValue == @((int)TrangThaiUngTuyen.ntddaxem)) {
                            // Hide "Đã xem" button if that was the action
                            $('.change-status-btn-detail[data-newstatus="@((int)TrangThaiUngTuyen.ntddaxem)"]').hide();
                        }
                        // If status is 'darut', all buttons should be disabled from the start via Razor.
                        // This JS handles changes from other states.

                    } else {
                        messageDiv.html('<div class="alert alert-danger alert-dismissible fade show" role="alert">Lỗi: ' + response.message + '<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button></div>');
                    }
                },
                error: function (xhr, status, error) {
                     $('#status-update-message-detail').html('<div class="alert alert-danger alert-dismissible fade show" role="alert">Lỗi máy chủ: ' + xhr.responseText + '<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button></div>');
                }
            });
        });
    });
    </script>
}

<style>
    .list-unstyled li { padding-bottom: 0.3rem; }
    .card-title { font-weight: 600; }
</style>