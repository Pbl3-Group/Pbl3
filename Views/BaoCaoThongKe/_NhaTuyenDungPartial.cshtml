@model HeThongTimViec.ViewModels.BaoCaoThongKeViewModel

<style>
    /* CSS được đóng gói trong partial view này để dễ quản lý */
    .stat-card-employer {
        background: linear-gradient(145deg, rgba(255, 255, 255, 0.9), rgba(255, 255, 255, 0.7));
        backdrop-filter: blur(5px);
        border: 1px solid rgba(0, 0, 0, 0.05);
        border-radius: 20px;
        padding: 2rem;
        text-align: center;
        transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        position: relative;
        overflow: hidden;
        min-height: 140px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.05);
    }
    
    .stat-card-employer:hover {
        transform: translateY(-8px) scale(1.02);
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
    }
    
    .stat-card-employer.verified {
        background: linear-gradient(145deg, #56ab2f, #a8e063);
        color: white;
    }
    
    .stat-card-employer.new-entry {
        background: linear-gradient(145deg, #8e2de2, #4a00e0);
        color: white;
    }

    .stat-card-employer .stat-icon {
        font-size: 3rem;
        margin-bottom: 1rem;
        opacity: 0.9;
        animation: float 3s ease-in-out infinite;
        text-shadow: 0 3px 6px rgba(0, 0, 0, 0.15);
    }
    
    .stat-card-employer .stat-title {
        font-size: 1.1rem;
        font-weight: 600;
        margin-bottom: 0.5rem;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    .stat-card-employer .stat-value {
        font-size: 1.2rem;
        opacity: 0.9;
        font-weight: 700;
    }
    
    .chart-card-employer {
        background: white;
        border: none;
        border-radius: 20px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.07);
        transition: all 0.3s ease;
        overflow: hidden;
        display: flex;
        flex-direction: column;
    }
    
    .chart-card-employer:hover {
        transform: translateY(-5px);
        box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
    }

    .chart-card-employer .card-header {
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
        border: none;
        padding: 1.5rem;
        border-radius: 20px 20px 0 0 !important;
    }
    
    .chart-card-employer .card-header h6 {
        margin: 0;
        font-size: 1.2rem;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .chart-card-employer .card-body {
        padding: 1.5rem;
        flex-grow: 1; 
    }
    
    .chart-card-employer .chart-container {
        position: relative;
        max-height: 350px; 
    }

    /* CSS mới cho khu vực phân tích nhanh */
    .insights-panel {
        background-color: #f8f9fa;
        border-radius: 15px;
        padding: 1.5rem;
        height: 100%;
        display: flex;
        flex-direction: column;
        justify-content: center;
    }

    .insights-title {
        font-weight: 600;
        color: #667eea;
        margin-bottom: 1.5rem;
        text-align: center;
    }
    .insight-item {
        text-align: center;
        margin-bottom: 1rem;
    }
    .insight-item .label {
        font-size: 0.9rem;
        color: #6c757d;
        margin-bottom: 0.25rem;
    }
    .insight-item .value {
        font-size: 1.5rem;
        font-weight: 700;
        color: #343a40;
    }
    .insight-item .top-industry {
        font-weight: 700;
        color: #8e2de2;
    }
</style>

<div class="container-fluid">
    <div class="row">
        <div class="col-md-6 col-lg-3 mb-4">
            <div class="stat-card-employer verified animate-on-scroll">
                <div class="stat-icon"><i class="fas fa-user-shield"></i></div>
                <div class="stat-title">NTD đã xác minh</div>
                <div class="stat-value">@Model.SoNhaTuyenDungDaXacMinh.ToString("N0")</div>
            </div>
        </div>
        <div class="col-md-6 col-lg-3 mb-4">
            <div class="stat-card-employer new-entry animate-on-scroll">
                <div class="stat-icon"><i class="fas fa-building"></i></div>
                <div class="stat-title">NTD mới (30 ngày)</div>
                <div class="stat-value">@Model.SoNhaTuyenDungMoi30Ngay.ToString("N0")</div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-6 mb-4">
            <div class="chart-card-employer h-100 animate-on-scroll">
                <div class="card-header">
                    <h6><i class="fas fa-users-cog"></i> Phân bố quy mô công ty</h6>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="employerSizeChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-6 mb-4">
            <div class="chart-card-employer h-100 animate-on-scroll">
                <div class="card-header">
                    <h6><i class="fas fa-map-marked-alt"></i> Phân bố địa lý (Top 5)</h6>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="employerLocationChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row">
        <div class="col-lg-12 mb-4">
            <div class="chart-card-employer animate-on-scroll">
                <div class="card-header">
                    <h6><i class="fas fa-sitemap"></i> Top 5 ngành nghề theo số lượng nhà tuyển dụng</h6>
                </div>
                 <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-lg-8">
                             <div class="chart-container" style="min-height: 400px;">
                                <canvas id="employerIndustryChart"></canvas>
                            </div>
                        </div>
                        <div class="col-lg-4">
                            <div class="insights-panel">
                                <h5 class="insights-title">Phân tích nhanh</h5>
                                @{
                                    var topIndustryLabel = "N/A";
                                    decimal topIndustryCount = 0;
                                    decimal totalTop5Count = 0;
                                    double topPercentage = 0;

                                    var industryDataset = Model.EmployerIndustryChart?.Datasets?.FirstOrDefault();
                                    if (industryDataset != null && industryDataset.Data.Any())
                                    {
                                        topIndustryLabel = Model.EmployerIndustryChart.Labels.FirstOrDefault() ?? "N/A";
                                        // Sử dụng Convert để đảm bảo an toàn kiểu dữ liệu
                                        topIndustryCount = Convert.ToDecimal(industryDataset.Data.FirstOrDefault());
                                        totalTop5Count = industryDataset.Data.Sum(d => Convert.ToDecimal(d));
                                        if (totalTop5Count > 0)
                                        {
                                            topPercentage = (double)(topIndustryCount / totalTop5Count * 100);
                                        }
                                    }
                                }
                                <div class="insight-item">
                                    <div class="label">Ngành nghề dẫn đầu</div>
                                    <div class="value top-industry">@topIndustryLabel</div>
                                </div>
                                <hr/>
                                <div class="insight-item">
                                    <div class="label">Số NTD trong ngành dẫn đầu</div>
                                    <div class="value">@topIndustryCount.ToString("N0")</div>
                                </div>
                                <hr/>
                                <div class="insight-item">
                                    <div class="label">% so với Top 5</div>
                                    <div class="value">@topPercentage.ToString("F1")%</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- THÊM CDN CHO PLUGIN DATALABELS -->
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // ... Script animateOnScroll() giữ nguyên ...
        const elements = document.querySelectorAll('.animate-on-scroll:not(.animated)');
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    entry.target.classList.add('animated');
                }
            });
        }, { threshold: 0.1 });
        elements.forEach(element => { observer.observe(element); });
        
        // ===================================================================
        // BIỂU ĐỒ "EMPLOYER INDUSTRY CHART"
        // Phần Javascript này đã chính xác và không cần sửa.
        // Nó đọc dữ liệu từ 'chartData' và hiển thị tooltip đúng.
        // Vấn đề nằm ở sự nhất quán của dữ liệu được chuẩn bị từ server.
        // ===================================================================

        // 1. Đăng ký plugin datalabels
        Chart.register(ChartDataLabels);

        const industryChartCanvas = document.getElementById('employerIndustryChart');
        if (industryChartCanvas) {
            const industryChartCtx = industryChartCanvas.getContext('2d');
            const chartData = @Html.Raw(Json.Serialize(Model.EmployerIndustryChart));

            // Thêm thứ hạng vào labels
            const originalLabels = [...chartData.labels]; // Lưu lại nhãn gốc để dùng trong tooltip
            chartData.labels = chartData.labels.map((label, index) => `#${index + 1}  ${label}`);
            
            // 2. Tạo màu gradient khác nhau cho các thanh
            const topColor = 'rgba(255, 107, 107, 0.8)'; // Màu hồng/đỏ cho top 1
            const otherColor = 'rgba(255, 159, 164, 0.7)'; // Màu hồng nhạt hơn cho các thanh còn lại
            
            const backgroundColors = chartData.datasets[0].data.map((_, index) => index === 0 ? topColor : otherColor);
            const borderColors = chartData.datasets[0].data.map((_, index) => index === 0 ? 'rgba(255, 107, 107, 1)' : 'rgba(255, 159, 164, 1)');


            chartData.datasets[0].backgroundColor = backgroundColors;
            chartData.datasets[0].borderColor = borderColors;
            chartData.datasets[0].borderWidth = 1;
            chartData.datasets[0].borderRadius = 8; 
            chartData.datasets[0].borderSkipped = false;

            // 3. Tạo biểu đồ với cấu hình mới
       new Chart(industryChartCtx, {
    type: 'bar',
    data: chartData,
    options: {
        indexAxis: 'y', 
        responsive: true,
        maintainAspectRatio: false,
        scales: {
            x: {
                beginAtZero: true,
                grid: { display: true, color: '#f0f0f0' },
                ticks: { 
                    font: { size: 12 }
                }
            },
            y: {
                grid: { display: false },
                ticks: {
                    font: {
                        size: 14,
                        weight: '500'
                    }
                }
            }
        },
        plugins: {
            legend: { display: false },
            tooltip: { display: false }, // Disable tooltip
            datalabels: { display: false }
        }
    }
});
        }
    });
</script>